define(["jquery","backbone","parse","../helpers/Progress","../helpers/PromiseFailReport","../models/SimpleTrait","../collections/BNSMETV1_ClanRules","../helpers/DescriptionFetcher"],function(e,t,i,n,a,c,r,l){return t.View.extend({initialize:function(){_.bindAll(this,"register","update_collection_query_and_fetch")},switch_character_category_listening:function(){var e=this;e.character&&(e.stopListening(e.character),e.listenTo(e.character,"change:"+e.category,e.render))},register:function(e,t,n,a,c,r){var o=this;o.delegateEvents();var s=!1;r=r||"#simpletrait/specialize/<%= self.category %>/<%= self.character.id %>/<%= b.linkId() %>";(a=a||"#simpletrait/<%= self.category %>/<%= self.character.id %>/<%= b.linkId() %>")!=_&&a!=o.redirect&&(o.redirect=_.template(a),s=!0),r!=_&&r!=o.specializationRedirect&&(o.specializationRedirect=_.template(r)),o.filterRule!==c&&(_.isString(c)?o.filterRule=[c]:o.filterRule=c,s=!0),n!==o.free_value&&n!=_&&(o.free_value=n,s=!0),e!==o.character&&(o.character&&o.stopListening(o.character),o.character=e,o.listenTo(o.character,"change:"+t,o.render),s=!0);var u=i.Promise.as();return t!=o.category&&(o.category=t,o.switch_character_category_listening(),o.collection&&o.stopListening(o.collection),o.collection=l(t),o.listenTo(o.collection,"add",o.render),o.listenTo(o.collection,"reset",o.render),u=o.update_collection_query_and_fetch(),s=!0),s?u.then(function(){o.render()}):u.then(function(){return o})},update_collection_query_and_fetch:function(){return n("Fetching "+this.category),this.collection.fetch_avoiding_wait().done(function(){n()}).fail(a)},render:function(){var t,i=this;i.requireSpecializations=_.chain(i.collection.models).select(function(e){return"requires_specialization"==e.get("requirement")}).pluck("attributes").pluck("name").value();var n=_(i.character.get(i.category)).pluck("attributes").pluck("name").without(i.requireSpecializations).value();if(_.contains(i.filterRule,"in clan disciplines")){var a=_.without(i.character.get_in_clan_disciplines(),void 0);t=_.chain(i.collection.models),0!=a.length&&(t=t.select(function(e){return!_.contains(n,e.get("name"))&&!!_.contains(a,e.get("name"))})),t=t.value()}else if(_.contains(i.filterRule,"affinity")){a=_.without(i.character.get_affinities(),void 0);t=_.chain(i.collection.models),0!=a.length&&(t=t.select(function(e){return!_.contains(n,e.get("name"))&&_.some(_.map(_.range(1,4),function(t){return!!_.contains(a,e.get("affinity_"+t))}))})),t=t.value()}else t=_.chain(i.collection.models).select(function(e){return!_.contains(n,e.get("name"))}).value();return _.contains(i.filterRule,"show_only_value_1")&&(t=_.select(t,function(e){return 1==e.get("value")})),this.template=_.template(e("script#simpletraitcategoryDescriptionItems").html())({collection:t,character:this.character,category:this.category,free_value:this.free_value}),this.$el.find("div[role='main']").html(this.template),this.$el.enhanceWithin(),this},events:{"click .simpletrait":"clicked"},clicked:function(t){var i=this;t.preventDefault(),i.undelegateEvents(),e.mobile.loading("show");var n=e(t.target).attr("backendId"),a=i.collection.get(n),c=_.parseInt(a.get("value")),r=i.free_value;return c&&(r=c),i.character.update_trait(e(t.target).attr("name"),r,i.category,i.free_value).done(function(e){_.contains(i.requireSpecializations,e.get("name"))?window.location.hash=i.specializationRedirect({self:i,b:e}):window.location.hash=i.redirect({self:i,b:e})}).fail(function(e){console.log(e.message)}),!1}})});