define(["jquery","backbone","backform","../models/Troupe","../forms/TroupeForm","text!../templates/troupe-staff-list.html","parse","text!../templates/troupe-portrait-display.html","text!../templates/troupe.html"],function(e,t,r,a,i,o,n,l,s){return t.View.extend({initialize:function(){this.writable=!1,_.bindAll(this,"render","addstaff")},register:function(t,a){var o=this,l=!1;return t===o.troupe&&a==o.writable||(o.troupe=t,o.writable=!!a,o.form=new i({el:"#troupe-data",model:o.troupe,events:{submit:function(t){t.preventDefault(),e.mobile.loading("show"),console.log(n.User.current().get("username")),this.model.save().then(function(e){console.log("Saved the troupe")}).fail(function(e){console.log("Failed to save troupe "+e.message),window.location.hash="#administration"}).always(function(){e.mobile.loading("hide")})}}}),o.writable&&o.form.fields.add(new r.Field({control:"button",label:"Update"})),l=!0),l?o.render():o},events:{"click .troupe-add-staff":"addstaff","click .troupe-view-characters":"viewcharacters","click .troupe-view-character-relationships":"viewrelationships","click .troupe-view-summarize-characters":"viewsummarizecharacters","click .troupe-view-print-characters":"viewprintcharacters"},addstaff:function(e){e.preventDefault(),window.location.hash="#troupe/"+this.troupe.id+"/staff/add"},viewcharacters:function(e){e.preventDefault(),window.location.hash="#troupe/"+this.troupe.id+"/characters/all"},viewsummarizecharacters:function(e){e.preventDefault(),window.location.hash="#troupe/"+this.troupe.id+"/characters/summarize/all"},viewprintcharacters:function(e){e.preventDefault(),window.location.hash="#troupe/"+this.troupe.id+"/characters/selecttoprint/all"},viewrelationships:function(e){e.preventDefault(),window.location.hash="#troupe/"+this.troupe.id+"/characters/relationships/network"},render:function(){var t=this;return t.template=_.template(s)({readonly:!t.writable}),t.$el.find("div[role='main']").html(t.template),t.form.setElement(e("#troupe-data")),t.form.render(),t.troupe.get_staff().then(function(e){t.staff_template=_.template(o)({collection:e}),t.$el.find("#troupe-staff").html(t.staff_template),t.$el.enhanceWithin()}),(t.troupe.get("portrait")?t.troupe.get("portrait").fetch():n.Promise.as([])).then(function(){var e=_.template(l)({troupe:t.troupe});t.$el.find("#troupe-portrait-display").html(e),t.$el.enhanceWithin()}),this}})});