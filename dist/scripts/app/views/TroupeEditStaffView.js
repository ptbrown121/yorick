define(["jquery","backbone","parse","backform","../helpers/PromiseFailReport"],function(e,t,o,r,n){return t.View.extend({initialize:function(){_.bindAll(this,"render","submit")},register:function(e,t){var n=this;n.troupe=e,n.user=t;var i={};return o.Promise.when(n.troupe.get_roles()).then(function(e){i=e;var t=_.map(n.troupe.title_options,function(e){var t=i[e].getUsers().query();return t.equalTo("objectId",n.user.id),t.count().then(function(t){i[e]=t,console.log("Setting up role "+e+" count with "+t)})});return o.Promise.when(t)}).then(function(){var e=_.findKey(i,function(e,t,o){return console.log("Got "+e+" for "+t),!!(_.isFinite(e)&&e>0)});return console.log("I found this user with a role of "+e),o.Promise.as(e)}).then(function(e){n.user.set("role",e||"None"),n.form=new r.Form({el:"#troupe-edit-staff-form",model:n.user,fields:[{name:"username",label:"Username",control:"uneditable-input"},{name:"realname",label:"Name",control:"uneditable-input"},{name:"role",label:"Role",control:"select",options:[{label:"Lead Storyteller",value:"LST"},{label:"Assistant Storyteller",value:"AST"},{label:"Narrator",value:"Narrator"},{label:"Not on Staff",value:"None"}]},{control:"spacer"},{control:"button",label:"Save"}]}),n.render()}).fail(function(e){_.isArray(e)?_.each(e,function(e){console.log("Something failed"+e.message)}):console.log("error updating experience"+e.message)})},events:{submit:"submit"},submit:function(e){var t=this;e.preventDefault();var r=t.user.get("role"),i=_.slice(t.troupe.title_options),l=[];return"None"!=r&&(l.push(r),i=_.xor(i,l)),o.Cloud.run("change_troupe_staff",{troupe_id:t.troupe.id,user_to_change_id:t.user.id,roles_to_add:l,roles_to_remove:i}).always(function(){window.location.hash="#troupe/"+t.troupe.id}).fail(n)},render:function(){return this.form.render(),this.$el.enhanceWithin(),this}})});