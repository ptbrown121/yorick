define(["underscore","parse","../collections/BNSMETV1_ClanRules"],function(t,e,n){return e.Object.extend("VampireCosts",{initialize:function(){var t=this;try{return t.ClanRules=BNSMETV1_ClanRules,e.Promise.as(t.ClanRules)}catch(e){return t.ClanRules=new n,t.ClanRules.fetch()}},get_in_clan_disciplines:function(e){var n=this.ClanRules.get_in_clan_disciplines(e),i=t.map(e.get("extra_in_clan_disciplines"),"attributes.name");return n=[].concat(n,i)},discipline_is_in_clan:function(e,n){var i=this.ClanRules.get_in_clan_disciplines(e),a=t.map(e.get("extra_in_clan_disciplines"),"attributes.name");return[]!=(i=[].concat(i,a))&&t.any(i,function(e){return!!t.eq(e,n.get_base_name())||!!t.eq(e,n.get("name"))})},get_cost_table:function(e){return t.map(t.range(1,10),function(t){return t*e})},get_cost_on_table:function(e,n){return t.chain(e).take(n).sum().value()},get_trait_cost_on_table:function(t,e){var n=e.get("value"),i=e.get("free_value")||0;return this.get_cost_on_table(t,n)-this.get_cost_on_table(t,i)},get_generation_cost_table:function(){var t=this.get_cost_table(2);return t[0]=1,t},calculate_trait_cost:function(t,e){var n=this,i=e.get("category"),a=e.get("name"),_=e.get("value")-(e.get("free_value")||0);if("attributes"==i)return 3*_;if("disciplines"==i&&n.discipline_is_in_clan(t,e))return n.get_trait_cost_on_table(n.get_cost_table(3),e);if("humanity"==i||"paths"==i)return 10*_;if("merits"==i)return _;if("flaws"==i)return-1*_;if("rituals"==i)return 2*_;var s,l,r,c=t.generation(),o=9999,u=99999,g=99999,b=99999;return"backgrounds"==i?(s="Generation"==a?n.get_generation_cost_table():1==c?n.get_cost_table(1):n.get_cost_table(2),n.get_trait_cost_on_table(s,e)):"skills"==i?(l=1==c?n.get_cost_table(1):n.get_cost_table(2),n.get_trait_cost_on_table(l,e)):"disciplines"==i?(r=c<5?n.get_cost_table(4):n.get_cost_table(5),n.get_trait_cost_on_table(r,e)):"techniques"==i?(c<3?o=12:3==c&&(o=20),_*o):"elder_disciplines"==i?(c>=3&&(u=18),c>=5?g=30:c>=3&&(g=24),n.discipline_is_in_clan(t,e)?_*u:_*g):"luminary_disciplines"==i?(c>=5&&n.discipline_is_in_clan(t,e)&&(b=24),_*b):void 0}})});