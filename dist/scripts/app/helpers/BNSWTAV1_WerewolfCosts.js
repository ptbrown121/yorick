define(["underscore","parse","backbone","../models/Description"],function(t,e,n,i){var r=n.Collection.extend({model:i});return e.Object.extend("WerewolfCosts",{initialize:function(){var t=this;return t.descriptions=new r,new e.Query(i).equalTo("category","wta_gifts").each(function(e){t.descriptions.add(e)})},get_affinities:function(t){return t.get_affinities()},gift_is_affinity:function(e,n){var i=n.get_base_name(),r=t.find(this.descriptions.models,function(t){return t.get("name")==i});if(!r)return!1;var a=t.without(t.map(t.range(1,4),function(t){var e=r.get("affinity_"+t);if(e)return e}),void 0);console.log(a);var o=this.get_affinities(e);return 0!=t.intersection(a,o).length},get_cost_table:function(e){return t.map(t.range(1,10),function(t){return t*e})},get_cost_on_table:function(e,n){return t.chain(e).take(n).sum().value()},get_trait_cost_on_table:function(t,e){var n=e.get("value"),i=e.get("free_value")||0;return this.get_cost_on_table(t,n)-this.get_cost_on_table(t,i)},calculate_trait_cost:function(e,n){var i=this,r=n.get("category"),a=(n.get("name"),n.get("value")-(n.get("free_value")||0)),o=n.get("experience_cost_type"),_=t.parseInt(n.get("experience_cost_modifier"));if("flat"==o)return a*_;if("linear"==o)return i.get_trait_cost_on_table(i.get_cost_table(_),n);if("attributes"==r)return 3*a;if("wta_gifts"==r)return i.gift_is_affinity(e,n)?4*a:6*a;if("wta_merits"==r)return a;if("wta_flaws"==r)return-1*a;if("wta_backgrounds"==r)return i.get_trait_cost_on_table(i.get_cost_table(2),n);var s,c=e.rank();return"skills"==r?(s=c>=3?i.get_cost_table(2):i.get_cost_table(1),i.get_trait_cost_on_table(s,n)):void 0}})});